cache:                                                                                                                               
  key: ${CI_COMMIT_REF_SLUG}
  paths:
  - .m2
  - .sonar/cache

stages:
  - build
  - quality

variables:
  MAVEN_USER: 'deployment'
  MAVEN_CLI_OPTS: "-DskipTests --batch-mode -Dmaven.repo.local=$CI_PROJECT_DIR/.m2"
  SONAR_HOST_URL: 'https://sonar.geomatys.com'
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  SONAR_HOST_URL: 'https://sonar.geomatys.com'
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task

build-linux:
  image: images.geomatys.com/ci/maven:3.6.3-oraclejdk-8-openjfx
  stage: build
  rules:
    - if: $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_TAG != null
  script:
    # Import certificate to fulfill part 5 of the readme
    - keytool -importcert -file $CERTIFICATE -alias certificate -keystore $JAVA_HOME/jre/lib/security/cacerts -storepass changeit -noprompt
    # Do a clean build
    - mvn $MAVEN_CLI_OPTS clean install -s $MAVEN_SETTINGS -Pall
    # Build native JFX packages
    - cd launcher
    - apt update
    - apt install -yqq fakeroot rpm
    - mvn $MAVEN_CLI_OPTS jfx:native -s $MAVEN_SETTINGS
  artifacts:
    paths:
      - launcher/target/jfx/native
      - plugin-*

build-windows:
  stage: build
  tags:
    - powershell
  rules:
    - if: $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_TAG != null
  script:
    - cd $env:CI_PROJECT_DIR\
    #- keytool -importcert -file $CERTIFICATE -alias certificate -storepass changeit -noprompt
    - mvn $MAVEN_CLI_OPTS clean install -s $MAVEN_SETTINGS -Pall -DskipTests
    - cd launcher
    - mvn $MAVEN_CLI_OPTS jfx:native -s $MAVEN_SETTINGS -DskipTests
  artifacts:
    paths:
      - launcher/target/jfx/native
      - plugin-*

build-macosx:
  stage: build
  tags:
    - macosx
  rules:
    - if: $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_TAG != null
  script:
    #- keytool -importcert -file $CERTIFICATE -alias certificate -storepass changeit -noprompt
    - mvn $MAVEN_CLI_OPTS clean install -s $MAVEN_SETTINGS -Pall
    - cd launcher
    - mvn $MAVEN_CLI_OPTS jfx:native -s $MAVEN_SETTINGS
  artifacts:
    paths:
      - launcher/target/jfx/native
      - plugin-*

quality:
  image: images.geomatys.com/ci/maven:3-jdk-8-openjfx
  stage: quality
  script:
    - mvn $MAVEN_CLI_OPTS sonar:sonar -s $MAVEN_SETTINGS
      -Dsonar.login=$SONAR_TOKEN
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.java.binaries=${CI_PROJECT_DIR}/.m2
      -s $SETTINGS_MAVEN
  allow_failure: true
  only:
    variables:
      - $SONAR_TOKEN
